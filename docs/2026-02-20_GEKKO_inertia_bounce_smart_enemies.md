# GEKKO 変更ログ: 慣性バウンス・敵AI大幅改善

## 1. プレイヤー慣性バウンス

### 問題
ブースト後に着地すると不自然にぴょんぴょんする。

### 解決: 仕様として組み込み
ジェットパック使用後の着地を「慣性移動」として正式な機能にした。

```js
// Z衝突解決後
if(player.grounded && recentJet > 0 && Math.abs(preVz) > 2){
  var bounceVz = Math.abs(preVz) * 0.3;  // 30%反発
  if(bounceVz > 1){
    player.vz = bounceVz;
    player.grounded = false;
    // 土埃パーティクル（音なし）
  }
}
```

**ポイント:**
- `recentJet > 0`: 直近0.4秒以内にジェット使用していた場合のみ
- `|preVz| > 2`: 十分な落下速度がある場合のみ
- 30%反発: 徐々に減衰して自然に止まる
- 効果音なし: ジャンプと区別、モメンタム移動として自然

## 2. 敵AI大幅改善

### 2a. エッジ検出（落下防止）

```js
// 1.2ユニット先に足場があるかチェック
var lookAhead = 1.2;
var nextX = e.x + tx * lookAhead;
var nextY = e.y + ty * lookAhead;
if(!enemyOverPlatform(nextX, nextY, e.z)){
  // エッジ検出! 方向反転 + 横歩き
  tx = -tx * 0.3;  ty = -ty * 0.3;
  // 垂直方向の成分を追加してエッジ沿いに歩く
  var px = -ty, py = tx;
  tx += px * 0.7; ty += py * 0.7;
}
```

**`enemyOverPlatform(x, y, z)`**: 指定位置に足場があるかチェックするヘルパー関数。
高さ許容範囲は z ± 1.0〜1.5 ユニット。

### 2b. ジャンプ & ブースト

```js
var E_JET_ACC = 22;   // 敵のジェット加速度（プレイヤー26より控えめ）
var E_JET_MAX = 1.0;  // 敵の燃料上限（プレイヤー1.2より少ない）
var E_JUMP_VEL = 5.5; // 敵のジャンプ速度（プレイヤー6.5より低い）

// 接地中 + プレイヤーが1.5u以上上 → ジャンプ
if(e.grounded && dz > 1.5 && e.jumpCD <= 0 && hDist < 15){
  e.vz = E_JUMP_VEL; e.grounded = false; e.jumpCD = 0.8;
}
// 空中 + プレイヤーがまだ上 + 燃料あり → ブースト
if(!e.grounded && dz > 1.0 && e.jetFuel > 0 && e.jumpCD <= 0){
  e.recentJet = 0.4;
  e.vz += E_JET_ACC * dt;
  // ジェット炎パーティクル
}
```

**敵 vs プレイヤーのパラメータ比較:**
| 項目 | プレイヤー | 敵 | 理由 |
|---|---|---|---|
| ジェット加速度 | 26 | 22 | 少し遅く、プレイヤーが逃げやすい |
| 燃料上限 | 1.2s | 1.0s | 上昇時間を短く制限 |
| ジャンプ速度 | 6.5 | 5.5 | プレイヤーより低いジャンプ |
| ジャンプCD | 0.15s | 0.8s | 連続ジャンプを制限 |

### 2c. 慣性バウンス（敵版）

```js
// 着地時にブースト直後なら反発
if(e.grounded && e.recentJet > 0 && Math.abs(ePreVz) > 2){
  var eBounce = Math.abs(ePreVz) * 0.25;  // 25%反発（プレイヤー30%より控えめ）
  if(eBounce > 0.8){
    e.vz = eBounce; e.grounded = false;
    // 土埃パーティクル
  }
}
```

### 2d. 落下ダメージ（無料リスポーン廃止）

```js
// 旧: 無条件でプレイヤー近くにリスポーン
if(e.z < VOID_Z){
  e.x = player.x + random * 10;  // 無料復活
}

// 新: 10ダメージ + 死亡判定 + 安全なスポーン地点にリスポーン
if(e.z < VOID_Z){
  e.hp -= 10;
  if(e.hp <= 0){ killEnemy(ei); continue; }
  // プレイヤーから8u以上離れたスポーン地点を選択
  // → チープなキル防止
}
```

**リスポーン地点の選択ロジック:**
- `spawnPts` 全レイヤーから検索
- プレイヤーから8u以上離れた最も近い地点を選択
- 見つからない場合は `spawnPts[0][0]` にフォールバック

### 2e. 敵に追加されたプロパティ

```js
enemies.push({
  ...,
  grounded: true,    // 接地状態
  jetFuel: 1.0,      // ジェット燃料
  jumpCD: 0,         // ジャンプクールダウン
  recentJet: 0       // 直近ジェット使用タイマー
});
```

## 変更前 vs 後

| 項目 | 旧AI | 新AI |
|---|---|---|
| 落下防止 | なし（歩き落ち） | 1.2u先をチェック、エッジで方向転換 |
| ジャンプ | 不可 | プレイヤーが上にいたらジャンプ |
| ブースト | 不可 | 空中でジェット使用、炎パーティクル付き |
| 慣性移動 | なし | 25%反発、土埃パーティクル |
| 落下時 | 無料リスポーン | 10ダメージ + 安全地点にリスポーン |
| 敵の動き | 単純追尾 | 知的な追尾（高低差対応） |

## 変更ファイル
- `js/fps.js` のみ
