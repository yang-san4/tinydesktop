# GEKKO 変更ログ: 二段ジャンプ・グラップル改善・敵床修正・マップ拡大

## 1. ジェットパック廃止 → 二段ジャンプ

### 問題
Space 長押しでジェットパックが無限に上昇でき、三段目以降のジャンプが出てしまう。

### 修正方針
ジェットパック（連続上昇）を完全廃止し、クリーンな二段ジャンプに置換。

### 実装

```js
// キー押下のエッジ検出
var spJustPressed = false;

// handleKey 内:
case 'Space':
  if (down && !keys.sp) spJustPressed = true; // 押した瞬間だけ true
  keys.sp = down;
  break;

// resolvePhysics 内:
if (spJustPressed) {
  spJustPressed = false;
  if (player.grounded) {
    // 1段目: 通常ジャンプ
    player.vz = JUMP_VEL;
    player.jumpCount = 1;
  } else if (player.jumpCount < 2) {
    // 2段目: 少し弱めのジャンプ (0.8倍)
    player.vz = JUMP_VEL * 0.8;
    player.jumpCount = 2;
    // パーティクルバースト（視覚フィードバック）
  }
}
if (player.grounded) player.jumpCount = 0; // 接地でリセット
```

**学習ポイント: キー押下のエッジ検出**
- `keys.sp` は「今押されているか」（ステート）
- `spJustPressed` は「今フレームで押された瞬間か」（イベント）
- `down && !keys.sp` で遷移を検出（false→true の瞬間）
- ジャンプは「押した瞬間」に1回だけ発動すべき（長押しで連射しない）

### 変更箇所
- `player.jetFuel` → `player.jumpCount` に置換
- HUD の燃料バーを「2ND JUMP RDY / USED」表示に変更
- ジェットパーティクル生成を削除
- モバイルタッチのジャンプボタンにも `spJustPressed` 対応

## 2. グラップル視覚改善

### 修正前
30個の単色ドットを直線補間で描画 → 細くて見えにくい。

### 修正後

**チェーン（鎖）表現:**
```js
// 50ステップの補間 + カテナリー風のたるみ
mz -= sag * Math.sin(t * PI) * 4 * t * (1-t);

// 太さ: 距離に応じてスケール
var thick = Math.max(1, Math.ceil(1.5 * iz));

// チェーンリンクの色交互
var link = ((i/3|0) % 2 === 0);
// link=true: シアン(0,229,255), link=false: 暗めシアン(40,180,220)
```

**鉤爪（フック）:**
```js
// 6本の突起（prongs）をフック先端に描画
var prongs = [[0,-1],[0,1],[-1,0],[1,0],[-1,-1],[1,-1]];
// 各突起を hsz (距離ベースのサイズ) で配置
// 中心は白く光る
```

**`t*(1-t)` パターン**: 0→0→1→1ではなく、中央で最大になる放物線。
チェーンのたるみに使うと、始点・終点はたるみゼロ、中央で最大たるみ。

## 3. 敵の床すり抜け修正

### 問題
敵が床をすり抜けて落下する。

### 原因分析
旧コード:
```js
if (e.z <= pTop && e.z > pTop - 0.5) { // ← 0.5ユニット幅しかない
  e.z = pTop; e.vz = 0; landed = true;
  break; // ← 最初のヒットで終了（最高面とは限らない）
}
```

1. **検出範囲が狭い**: `pTop-0.5` の 0.5 ユニット幅でしか検出しない。
   重力加速度 18m/s² で 0.83 秒後に vz=15 → 1フレーム(dt=0.033)で 0.5 を超過 → すり抜け。
2. **`break` で最初のヒットのみ**: 複数のプラットフォームが重なる場合、最高面ではなく最初に見つかった面に着地。

### 修正

```js
// prevZ を記録（フレーム間の移動を追跡）
e.prevZ = e.z;
e.z += e.vz * dt;

// 全プラットフォームを走査して最高の着地面を探す
var bestTop = VOID_Z;
for (var pi = 0; pi < platforms.length; pi++) {
  // ... XY範囲チェック ...
  var pTop = pl.z + pl.h;
  // 前フレームで表面の近くにいて、今フレームで表面以下
  if (e.prevZ >= pTop - 0.2 && e.z <= pTop + 0.2 && pTop > bestTop) {
    bestTop = pTop;
  }
}
if (bestTop > VOID_Z && e.z <= bestTop) {
  e.z = bestTop; e.vz = 0; // 最高面にスナップ
}
```

**修正ポイント:**
1. `prevZ` で前フレーム位置を保持 → 高速落下でもフレーム間の「通過」を検出
2. `break` せず全プラットフォームを走査 → `bestTop` で最高面を選択
3. 許容範囲を `±0.2` に拡大 → 浮動小数点誤差にも対応

## 4. マップ拡大（1.4倍スケール）

### アプローチ
全座標を手動で書き換えるのではなく、**ジオメトリ生成後にポスト処理で拡大**:

```js
var _ms = 1.4;
function _scaleArr(arr) {
  for (var i = 0; i < arr.length; i++) {
    var a = arr[i];
    // 中央ドック(|x|≤12, |y|≤12)は除外
    if (Math.abs(a.x) > 12 || Math.abs(a.y) > 12) {
      a.x *= _ms;
      a.y *= _ms;
    }
  }
}
_scaleArr(platforms);
_scaleArr(decor);
```

**閾値 12 の根拠:**
- 中央ドックの最遠要素: (±10, ±10) → 距離 14.1 → |x|=10, |y|=10 < 12 → 除外 OK
- ドックステップ: (5, 11) → |y|=11 < 12 → 除外 OK
- マーケット島: (-7, 17) → |y|=17 > 12 → スケール対象 OK

### 接続ブリッジの追加
スケール後に追加（ポストスケール座標を直接指定）:

```js
// ドック↔マーケット接続（4方向）
P(0, 15, 0.8, 3, 14, 0.2, S3, S3s);   // 北
P(0, -15, 0.8, 3, 14, 0.2, S3, S3s);  // 南
P(-15, 0, 1.2, 14, 3, 0.2, S3, S3s);  // 西
P(15, 0, 1.2, 14, 3, 0.2, S3, S3s);   // 東
// マーケット間橋
P(0, 23.8, 2.9, 24, 2.5, 0.2, S3, S3s);  // NW↔NE
// タワーキャットウォーク（広い）
P(0, 27, 7.0, 34, 1.5, 0.15, NC, NCs);
```

### その他の調整
- 敵の行動範囲: ±25 → ±35
- スポーンポイント: 各島の新座標に合わせて更新
- ミニマップ: 表示範囲 50→70 ワールドユニット

## 変更ファイル
- `js/fps.js` のみ（2158行 → 2221行）
